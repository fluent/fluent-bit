# Unified Fluent Bit Configuration
# Combines OTEL ingestion with Kubernetes autodiscovery support

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf
    Plugins_File plugins.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020
    Health_Check On

# ============================================================
# INPUTS
# ============================================================

# OpenTelemetry gRPC input for receiving OTLP data
[INPUT]
    Name              opentelemetry
    Tag               otel
    Listen            0.0.0.0
    Port              4317
    buffer_max_size   50MB
    buffer_chunk_size 10MB

# HTTP input for receiving OTLP JSON traces
[INPUT]
    Name              http
    Tag               otlp.traces
    Listen            0.0.0.0
    Port              4318
    buffer_max_size   50MB
    buffer_chunk_size 10MB

# Tail Kubernetes container logs from minikube
[INPUT]
    Name              tail
    Tag               kube.*
    Path              /var/log/containers/*.log
    Parser            docker
    DB                /var/log/flb_kube.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

# ============================================================
# FILTERS
# ============================================================

# Kubernetes filter - enrich logs with pod metadata and annotations
[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     kube.var.log.containers.
    Merge_Log           On
    Merge_Log_Key       log_processed
    K8S-Logging.Parser  On
    K8S-Logging.Exclude On
    Labels              On
    Annotations         On

# Lua filter - process annotations for dynamic stream routing
[FILTER]
    Name          lua
    Match         kube.*
    Script        /fluent-bit/scripts/parseable_routing.lua
    Call          process_record

# Add common metadata to all records
[FILTER]
    Name          record_modifier
    Match         *
    Record        environment demo
    Record        source fluent-bit
    Record        fluent_bit_version 4.2.1

# ============================================================
# OUTPUTS - OTEL Data (Logs, Metrics, Traces)
# ============================================================

# Output OTEL gRPC Logs to Parseable
[OUTPUT]
    Name          parseable
    Match         *_logs
    Host          anton
    Port          8010
    TLS           Off
    Stream        grpc-logs
    data_type     logs
    log_source    otel-logs
    auth_header   Basic YWRtaW46YWRtaW4=
    compress      gzip
    Retry_Limit   3

# Output OTEL gRPC Metrics to Parseable
[OUTPUT]
    Name          parseable
    Match         *_metrics
    Host          anton
    Port          8010
    TLS           Off
    Stream        grpc-metrics
    data_type     otel-metric
    log_source    otel-metrics
    auth_header   Basic YWRtaW46YWRtaW4=
    compress      gzip
    Retry_Limit   3

# Output OTEL gRPC Traces to Parseable
[OUTPUT]
    Name          parseable
    Match         *_traces
    Host          anton
    Port          8010
    TLS           Off
    Stream        grpc-traces
    data_type     otel-trace
    log_source    otel-traces
    auth_header   Basic YWRtaW46YWRtaW4=
    compress      gzip
    Retry_Limit   3

# ============================================================
# OUTPUTS - Kubernetes Autodiscovery (Dynamic Stream Routing)
# ============================================================

# Output for Kubernetes logs with dynamic stream routing
# Matches: kube.* tags and parseable.* tags (from rewrite_tag)
[OUTPUT]
    Name           parseable
    Match_Regex    ^(kube\.|parseable\.).*
    Host           anton
    Port           8010
    TLS            Off
    Stream         default-k8s-logs
    log_source     otel-logs
    auth_header    Basic YWRtaW46YWRtaW4=
    compress       gzip
    dynamic_stream On
    Retry_Limit    3

# ============================================================
# DEBUG OUTPUT
# ============================================================

# Stdout for debugging (comment out in production)
#[OUTPUT]
#    Name          stdout
#    Match         *
#    Format        json_lines
