# Fluent Bit configuration example for AWS MSK with IAM authentication
# This example demonstrates how to configure Kafka input/output plugins
# with AWS MSK IAM authentication for different scenarios.

[SERVICE]
    Flush      5
    Grace      30
    Log_Level  info

# ==============================================================================
# Example 1: Standard MSK cluster with auto-detected region
# ==============================================================================
# The region is automatically extracted from the broker hostname
# Works for standard MSK endpoints like:
#   b-1.example.kafka.us-east-1.amazonaws.com
#   b-2.example.kafka.us-east-1.amazonaws.com

[INPUT]
    Name kafka
    brokers b-1.example.kafka.us-east-1.amazonaws.com:9098,b-2.example.kafka.us-east-1.amazonaws.com:9098
    topics my-input-topic
    group_id my-consumer-group
    # Enable AWS MSK IAM authentication
    rdkafka.sasl.mechanism aws_msk_iam
    # Region will be auto-detected from broker hostname
    # No need to set aws_region explicitly

[OUTPUT]
    Name kafka
    Match *
    brokers b-1.example.kafka.us-east-1.amazonaws.com:9098,b-2.example.kafka.us-east-1.amazonaws.com:9098
    topics my-output-topic
    # Enable AWS MSK IAM authentication
    rdkafka.sasl.mechanism aws_msk_iam
    # Region will be auto-detected from broker hostname

# ==============================================================================
# Example 2: MSK cluster via PrivateLink with explicit region
# ==============================================================================
# When using PrivateLink aliases or custom DNS names that don't contain
# .amazonaws.com, you must explicitly specify the aws_region parameter

[INPUT]
    Name kafka
    Tag kafka.privatelink
    brokers my-privatelink-alias.internal.example.com:9098
    topics my-input-topic
    group_id my-consumer-group
    # Enable AWS MSK IAM authentication
    rdkafka.sasl.mechanism aws_msk_iam
    # REQUIRED: Explicitly set region for custom DNS names
    aws_region us-east-1

[OUTPUT]
    Name kafka
    Match kafka.privatelink
    brokers my-privatelink-alias.internal.example.com:9098
    topics my-output-topic
    # Enable AWS MSK IAM authentication
    rdkafka.sasl.mechanism aws_msk_iam
    # REQUIRED: Explicitly set region for custom DNS names
    aws_region us-east-1

# ==============================================================================
# Example 3: MSK Serverless with auto-detected region
# ==============================================================================
# MSK Serverless endpoints are automatically detected

[INPUT]
    Name kafka
    Tag kafka.serverless
    brokers boot-abc123.c1.kafka-serverless.us-west-2.amazonaws.com:9098
    topics my-serverless-topic
    group_id my-serverless-group
    # Enable AWS MSK IAM authentication
    rdkafka.sasl.mechanism aws_msk_iam
    # Region will be auto-detected from broker hostname

[OUTPUT]
    Name kafka
    Match kafka.serverless
    brokers boot-abc123.c1.kafka-serverless.us-west-2.amazonaws.com:9098
    topics my-serverless-output
    # Enable AWS MSK IAM authentication
    rdkafka.sasl.mechanism aws_msk_iam

# ==============================================================================
# Example 4: VPC Endpoint with auto-detected region
# ==============================================================================
# VPC endpoints are also supported with auto-detection

[INPUT]
    Name kafka
    Tag kafka.vpce
    brokers vpce-abc123.kafka.us-east-1.vpce.amazonaws.com:9098
    topics my-vpce-topic
    group_id my-vpce-group
    # Enable AWS MSK IAM authentication
    rdkafka.sasl.mechanism aws_msk_iam
    # Region will be auto-detected from VPC endpoint hostname

[OUTPUT]
    Name kafka
    Match kafka.vpce
    brokers vpce-abc123.kafka.us-east-1.vpce.amazonaws.com:9098
    topics my-vpce-output
    # Enable AWS MSK IAM authentication
    rdkafka.sasl.mechanism aws_msk_iam

# ==============================================================================
# Notes:
# ==============================================================================
# 
# 1. AWS Credentials:
#    MSK IAM authentication uses the standard AWS credentials chain:
#    - Environment variables (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
#    - EC2 instance profile / ECS task role
#    - AWS credentials file (~/.aws/credentials)
# 
# 2. IAM Permissions Required:
#    Your IAM role/user needs the following permissions:
#    - kafka-cluster:Connect
#    - kafka-cluster:DescribeTopic (for consumers and producers)
#    - kafka-cluster:ReadData (for consumers)
#    - kafka-cluster:DescribeGroup (for consumers)
#    - kafka-cluster:AlterGroup (for consumers)
#    - kafka-cluster:WriteData (for producers)
#    - kafka-cluster:WriteDataIdempotently (for idempotent producers, optional)
#    - kafka-cluster:DescribeTransactionalId (for transactional producers, optional)
#    - kafka-cluster:AlterTransactionalId (for transactional producers, optional)
# 
# 3. When to use aws_region parameter:
#    - REQUIRED for PrivateLink aliases or any custom DNS names
#    - OPTIONAL for standard AWS MSK endpoints (auto-detected)
#    - OPTIONAL for MSK Serverless endpoints (auto-detected)
#    - OPTIONAL for VPC endpoints (auto-detected)
# 
# 4. Security Protocol:
#    When using aws_msk_iam, the security protocol is automatically
#    set to SASL_SSL. You don't need to configure it explicitly.
# 
# 5. Additional rdkafka options:
#    You can pass any librdkafka configuration option using the
#    rdkafka. prefix, for example:
#    - rdkafka.socket.timeout.ms 60000
#    - rdkafka.metadata.max.age.ms 180000
