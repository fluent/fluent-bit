---
driver:
  name: dokken
  chef_version: current
  privileged: true # because Docker and systemd/Upstart
  volumes:
    - /sys/fs/cgroup:/sys/fs/cgroup # because of systemd

transport:
  name: dokken

provisioner:
  name: dokken
  always_update_cookbooks: true

verifier:
  name: inspec

platforms:
  - name: centos-7
    driver:
      image: dokken/centos-7
      pid_one_command: /usr/lib/systemd/systemd
      # Official install then upgrade to staging
      intermediate_instructions:
        - ENV RELEASE_URL <%= ENV['RELEASE_URL'] %>
        - RUN rpm --import $RELEASE_URL/fluentbit.key
        - RUN echo -e "[td-agent-bit]\nname = Ttd-agent-bit\nbaseurl = $RELEASE_URL/centos/7/\$basearch/\ngpgcheck=1\ngpgkey=$RELEASE_URL/fluentbit.key\nenabled=1" > /etc/yum.repos.d/td-agent-bit.repo
        - RUN yum update -y && yum install -y td-agent-bit
        - RUN systemctl enable td-agent-bit
        - RUN rm -f /etc/yum.repos.d/td-agent-bit.repo
        - ENV AWS_URL <%= ENV['AWS_URL'] %>
        - ENV STAGING_VERSION <%= ENV['STAGING_VERSION'] %>
        - RUN rpm --import "$AWS_URL/fluentbit.key"
        - RUN wget "$AWS_URL/centos.repo" -O /etc/yum.repos.d/staging.repo
        - RUN yum update -y && yum install -y td-agent-bit
        - RUN systemctl enable td-agent-bit

  - name: amazonlinux-2
    driver:
      image: dokken/amazonlinux-2
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - ENV RELEASE_URL <%= ENV['RELEASE_URL'] %>
        - RUN rpm --import $RELEASE_URL/fluentbit.key
        - RUN echo -e "[td-agent-bit]\nname = Ttd-agent-bit\nbaseurl = $RELEASE_URL/amazonlinux/2/\$basearch/\ngpgcheck=1\ngpgkey=$RELEASE_URL/fluentbit.key\nenabled=1" > /etc/yum.repos.d/td-agent-bit.repo
        - RUN yum update -y && yum install -y td-agent-bit
        - RUN systemctl enable td-agent-bit
        - RUN rm -f /etc/yum.repos.d/td-agent-bit.repo
        - ENV AWS_URL <%= ENV['AWS_URL'] %>
        - ENV STAGING_VERSION <%= ENV['STAGING_VERSION'] %>
        - RUN rpm --import "$AWS_URL/fluentbit.key"
        - RUN wget "$AWS_URL/amazonlinux.repo" -O /etc/yum.repos.d/staging.repo
        - RUN yum update -y && yum install -y td-agent-bit
        - RUN systemctl enable td-agent-bit

  - name: ubuntu-18.04
    driver:
      image: dokken/ubuntu-18.04
      pid_one_command: /bin/systemd
      # Following official instructions: https://docs.fluentbit.io/manual/installation/linux/ubuntu
      intermediate_instructions:
        - ENV RELEASE_URL <%= ENV['RELEASE_URL'] %>
        - RUN wget -qO - $RELEASE_URL/fluentbit.key | apt-key add -
        - RUN echo "deb $RELEASE_URL/ubuntu/bionic bionic main" >> /etc/apt/sources.list
        - RUN apt-get update && apt-get install -y td-agent-bit
        - RUN systemctl enable td-agent-bit
        - RUN head -n -1 /etc/apt/sources.list > /tmp/sources.list && mv /tmp/sources.list /etc/apt/sources.list
        - ENV AWS_URL <%= ENV['AWS_URL'] %>
        - ENV STAGING_VERSION <%= ENV['STAGING_VERSION'] %>
        - RUN wget -qO - $AWS_URL/fluentbit.key | apt-key add -
        - RUN echo "deb $AWS_URL/ubuntu/bionic bionic main" >> /etc/apt/sources.list
        - RUN apt-get update && apt-get install -y td-agent-bit
        - RUN systemctl enable td-agent-bit

  - name: ubuntu-20.04
    driver:
      image: dokken/ubuntu-20.04
      pid_one_command: /bin/systemd
      intermediate_instructions:
        - ENV RELEASE_URL <%= ENV['RELEASE_URL'] %>
        - RUN wget -qO - $RELEASE_URL/fluentbit.key | apt-key add -
        - RUN echo "deb  $RELEASE_URL/ubuntu/focal focal main" >> /etc/apt/sources.list
        - RUN apt-get update && apt-get install -y td-agent-bit
        - RUN systemctl enable td-agent-bit
        - RUN head -n -1 /etc/apt/sources.list > /tmp/sources.list && mv /tmp/sources.list /etc/apt/sources.list
        - ENV AWS_URL <%= ENV['AWS_URL'] %>
        - ENV STAGING_VERSION <%= ENV['STAGING_VERSION'] %>
        - RUN wget -qO - $AWS_URL/fluentbit.key | apt-key add -
        - RUN echo "deb $AWS_URL/ubuntu/focal focal main" >> /etc/apt/sources.list
        - RUN apt-get update && apt-get install -y td-agent-bit
        - RUN systemctl enable td-agent-bit

  - name: debian-10
    driver:
      image: dokken/debian-10
      pid_one_command: /bin/systemd
      intermediate_instructions:
        - ENV RELEASE_URL <%= ENV['RELEASE_URL'] %>
        - RUN wget -qO - $RELEASE_URL/fluentbit.key | apt-key add -
        - RUN echo "deb $RELEASE_URL/debian/buster buster main" >> /etc/apt/sources.list
        - RUN apt-get update && apt-get install -y td-agent-bit
        - RUN systemctl enable td-agent-bit
        - RUN head -n -1 /etc/apt/sources.list > /tmp/sources.list && mv /tmp/sources.list /etc/apt/sources.list
        - ENV AWS_URL <%= ENV['AWS_URL'] %>
        - ENV STAGING_VERSION <%= ENV['STAGING_VERSION'] %>
        - RUN wget -qO - $AWS_URL/fluentbit.key | apt-key add -
        - RUN echo "deb $AWS_URL/debian/buster buster main" >> /etc/apt/sources.list
        - RUN apt-get update && apt-get install -y td-agent-bit
        - RUN systemctl enable td-agent-bit

suites:
  - name: default
    verifier:
      inspec_tests:
        - packaging/testing/smoke/packages