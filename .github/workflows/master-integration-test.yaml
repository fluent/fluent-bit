name: Build master docker images for integration tests
on:
  push:
    branches:
      - master
jobs:
  master-integration-test-build:
    uses: fluent/fluent-bit/.github/workflows/call-integration-image-build.yaml@master
    with:
      ref: ${{ github.sha }}
      registry: ghcr.io
      username: ${{ github.actor }}
      image: ${{ github.repository }}
      image-tag: x86_64-master
      environment: integration
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}

  master-integration-test-build-complete:
    runs-on: ubuntu-latest
    needs: master-integration-test-build
    steps:
      - uses: actions/checkout@v2
        with:
          repository: calyptia/fluent-bit-ci
          path: ci
      - run: |
          ci/scripts/grafana-add-tag.sh
        env:
          GRAFANA_CLOUD_TOKEN: ${{ secrets.GRAFANA_CLOUD_TOKEN }}
          COMMIT_ID: ${{ github.sha }}
        working-directory: ci/

  master-integration-test-run-integration-gcp:
    needs: master-integration-test-build
    uses: calyptia/fluent-bit-ci/.github/workflows/reusable-integration-test-gcp.yaml@main
    with:
      image_name: ghcr.io/${{ github.repository }}
      image_tag: x86_64-master
    secrets:
      grafana_username: ${{ secrets.GRAFANA_USERNAME }}
      terraform_api_token: ${{ secrets.TF_API_TOKEN }}
      gcp_service_account_key: ${{ secrets.GCP_SA_KEY }}
      grafana_password: ${{ secrets.GRAFANA_PASSWORD }}
